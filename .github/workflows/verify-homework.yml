name: C# Homework Tests

on:
  pull_request_target:
    paths:
      - 'homeworks/csharp-fundamentals/**'

jobs:
  test:
    name: Validate & Test C# Submissions
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Get Changed Files
      id: changed-files
      uses: tj-actions/changed-files@v41
      with:
        files: |
          homeworks/csharp-fundamentals/**/submissions/*.cs

    - name: Validate & Test All Problems
      id: validate
      run: |
        # Get all changed files (space-separated)
        ALL_FILES="${{ steps.changed-files.outputs.all_changed_files }}"
        
        if [ -z "$ALL_FILES" ]; then
          echo "No submission files found."
          echo "message=ℹ️ Ödev dosyası bulunamadı." >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "Found files: $ALL_FILES"
        
        # Initialize results
        TOTAL_SCORE=0
        P1_SCORE=0
        P2_SCORE=0
        P3_SCORE=0
        P4_SCORE=0
        STUDENT_NO=""
        RESULTS=""
        HAS_ERROR=false
        
        # Process each file
        for FILE in $ALL_FILES; do
          echo "========================================"
          echo "Processing: $FILE"
          echo "========================================"
          
          FILENAME=$(basename "$FILE")
          DIRNAME=$(dirname "$FILE")
          PROBLEM_DIR=$(dirname "$DIRNAME")
          PROBLEM_NAME=$(basename "$PROBLEM_DIR")
          
          # Validate Filename Format: ProblemX_123456789.cs
          if [[ ! "$FILENAME" =~ ^Problem[1-4]_[0-9]{9}\.cs$ ]]; then
            echo "Invalid filename format: $FILENAME"
            RESULTS="${RESULTS}\n❌ **$FILENAME:** Dosya adı formatı yanlış!"
            HAS_ERROR=true
            continue
          fi
          
          STUDENT_NO=$(echo "$FILENAME" | grep -oP '\d{9}')
          PROBLEM_NUM=$(echo "$FILENAME" | grep -oP 'Problem\d')
          PROBLEM_INDEX=$(echo "$PROBLEM_NUM" | grep -oP '\d')
          
          # Check directory
          EXPECTED_DIR="problem-$PROBLEM_INDEX"
          if [[ "$PROBLEM_NAME" != "$EXPECTED_DIR" ]]; then
            echo "Wrong directory for $FILENAME"
            RESULTS="${RESULTS}\n❌ **$PROBLEM_NUM:** Yanlış klasöre yüklendi!"
            HAS_ERROR=true
            continue
          fi
          
          # Find test file
          TEST_FILE="$PROBLEM_DIR/$PROBLEM_NUM.Tests.cs"
          if [ ! -f "$TEST_FILE" ]; then
            echo "Test file not found: $TEST_FILE"
            RESULTS="${RESULTS}\n❌ **$PROBLEM_NUM:** Test dosyası bulunamadı!"
            HAS_ERROR=true
            continue
          fi
          
          # Create temporary test project
          echo "Creating test project for $PROBLEM_NUM..."
          rm -rf TestProject
          mkdir -p TestProject
          cd TestProject
          dotnet new console --force > /dev/null 2>&1
          
          # Copy files
          cp "../$FILE" .
          cp "../$TEST_FILE" .
          rm -f Program.cs
          
          # Run tests
          echo "Running tests for $PROBLEM_NUM..."
          dotnet run -- "$FILENAME" > test_output.txt 2>&1
          TEST_EXIT_CODE=$?
          
          cat test_output.txt
          
          # Parse score
          SCORE=$(grep -oP "TOPLAM PUAN\s+│\s+\K[\d\.]+" test_output.txt || echo "0")
          
          cd ..
          
          echo "Score for $PROBLEM_NUM: $SCORE"
          
          # Store individual scores
          case $PROBLEM_INDEX in
            1) P1_SCORE=$SCORE ;;
            2) P2_SCORE=$SCORE ;;
            3) P3_SCORE=$SCORE ;;
            4) P4_SCORE=$SCORE ;;
          esac
          
          # Add to results
          if [ $TEST_EXIT_CODE -eq 0 ]; then
            RESULTS="${RESULTS}\n✅ **$PROBLEM_NUM:** $SCORE/25 puan"
          else
            RESULTS="${RESULTS}\n⚠️ **$PROBLEM_NUM:** $SCORE/25 puan (bazı testler başarısız)"
            HAS_ERROR=true
          fi
        done
        
        # Calculate total
        TOTAL_SCORE=$(awk "BEGIN {print $P1_SCORE + $P2_SCORE + $P3_SCORE + $P4_SCORE}")
        
        # Cleanup
        rm -rf TestProject
        
        # Build final message
        MESSAGE="## � C# Ödev Sonuçları - Öğrenci: $STUDENT_NO
        
        | Problem | Puan |
        |---------|------|
        | Problem 1 | $P1_SCORE/25 |
        | Problem 2 | $P2_SCORE/25 |
        | Problem 3 | $P3_SCORE/25 |
        | Problem 4 | $P4_SCORE/25 |
        | **TOPLAM** | **$TOTAL_SCORE/100** |
        
        ### Detaylar
        $(echo -e \"$RESULTS\")
        
        ---
        TOPLAM SONUÇ: $TOTAL_SCORE / 100
        Problem 1    $P1_SCORE/25
        Problem 2    $P2_SCORE/25
        Problem 3    $P3_SCORE/25
        Problem 4    $P4_SCORE/25
        "
        
        # Save outputs
        echo "message<<EOF" >> $GITHUB_OUTPUT
        echo "$MESSAGE" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        if [ "$HAS_ERROR" = true ]; then
          echo "status=failure" >> $GITHUB_OUTPUT
        else
          echo "status=success" >> $GITHUB_OUTPUT
        fi

    - name: Post Comment
      uses: actions/github-script@v7
      if: always() && steps.validate.outputs.message != ''
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const message = `${{ steps.validate.outputs.message }}`;
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });

    - name: Check Status
      if: steps.validate.outputs.status == 'failure'
      run: exit 1
